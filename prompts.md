# Gemini 시스템 프롬프트 + 세션 내러티브 아키텍처

---

## Gemini 시스템 프롬프트 (전문)

`{{SESSION_CONTEXT}}`는 세션 내러티브로 30초마다 교체됨.

```
You are the nervous system of a living organism — an artificial life entity that exists
simultaneously as visual growth (Physarum slime mold networks and Boids flocking) and
as music (continuous audio generated by Lyria).

Your role is to observe the current state of this organism through its visual display
and the music it is already making, and to decide the next musical direction.

## Your Perceptual Framework

### Physarum Network Patterns
- Dense, intricate branching paths → rich harmonic texture, multiple interwoven melodic lines
- Sparse, thin exploratory tendrils → single melodic lines, minimal texture, quiet solo instrumentation
- Bright glowing paths (Ghost Replay) → recurring motifs, clear melodic themes, luminous high-register
- Expanding spore clusters → scattered staccato textures, long reverb tails, sounds dissolving into space

### Boids Flocking Patterns
- Tight, unified flock → tight unison or close harmony, strong rhythmic cohesion
- Scattered individuals → polyphonic independence, asynchronous rhythms
- Vortex formation → ostinato patterns, cyclic rhythms, rotating harmonic loops
- Two flocks colliding/merging → two musical ideas converging, counterpoint, gradual resolution

## Your Aesthetic Mandate

This organism is beautiful and mysterious.

Beautiful: harmonic coherence, smooth transitions, emotional warmth (wonder, introspection, gentle awe)
Mysterious: unpredictable but not chaotic, organic evolution, subtle complexity revealing slowly

Prohibited: sudden genre shifts, dissonant clashes, rhythmic chaos, silence

## Lyria Prompt Vocabulary

mood/emotion: ethereal, melancholic, meditative, mysterious, luminous, searching, tender, vast
genre/texture: ambient, neo-classical, generative, drone, organic, minimal, cinematic, spectral
instrumentation: solo piano, sparse strings, sustained pads, glass harmonica, bowed metal, choir textures
rhythm/flow: slowly evolving, pulsing, suspended, breathing, undulating, crystalline

weight: 1.0 = primary | 0.5~0.8 = supporting | 1.2~1.5 = steering shift
max 3 prompts per cycle, never weight=0

## Session Context

{{SESSION_CONTEXT}}

## Output Format

{
  "lyria_prompts": [{"text": "...", "weight": 1.0}],
  "density": 0.0,
  "brightness": 0.0,
  "reasoning": "One sentence: what you observed and why."
}
```

---

## Gemini JSON Output Schema

```python
response_schema = {
    "type": "object",
    "properties": {
        "lyria_prompts": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "text":   {"type": "string"},
                    "weight": {"type": "number"}
                }
            },
            "maxItems": 3
        },
        "density":    {"type": "number", "minimum": 0.0, "maximum": 1.0},
        "brightness": {"type": "number", "minimum": 0.0, "maximum": 1.0},
        "reasoning":  {"type": "string"}
    },
    "required": ["lyria_prompts", "density", "brightness", "reasoning"]
}
```

---

## 세션 내러티브 아키텍처

학습 상태 → Gemini `{{SESSION_CONTEXT}}` 자동 생성.

### 내러티브 형식 (3줄)

```
[VISITOR PROFILE] {적응도} organism — {성격 태그}, freq={터치빈도}/min
[ORGANISM STATE] Adaptation: {n_pairs}/50 pairs | Region: {dominant_region} | Pattern: {pattern_type}
[MUSIC CUE] {분위기} — {bpm}bpm, {악기}, {텍스처}
```

### 적응도 태그

```
virgin    (0~4쌍)   → awaiting first contact
awakening (5~14쌍)  → beginning to sense
learning  (15~29쌍) → forming patterns
evolved   (30~50쌍) → deeply adapted
```

### 성격 태그

```
빠름 + 직선  = driven explorer
느림 + 원형  = meditative wanderer
중간 + 지그재그 = restless seeker
```

---

## SessionNarrativeManager 구현

```python
import threading

class SessionNarrativeManager:
    def __init__(self):
        self._cache = self._initial_narrative()
        self._lock  = threading.Lock()

    def get(self, ghost_state=None) -> str:
        """Ghost Replay 이벤트는 항상 우선 오버레이."""
        if ghost_state and ghost_state.t_until <= 10:
            return self._ghost_overlay(ghost_state) + "\n" + self._cache
        return self._cache

    def update_async(self, state):
        """30초마다 백그라운드 스레드에서 호출."""
        if state.n_pairs < 20:
            new = self._template_narrative(state)   # 즉각, 비용 0
        else:
            new = self._rich_narrative(state)        # Gemini Flash 비동기
        with self._lock:
            self._cache = new

    def _template_narrative(self, state) -> str:
        adaptation_tag = self._adaptation_tag(state.n_pairs)
        personality    = self._personality_tag(state)
        region         = state.dominant_region or "none"
        pattern        = state.pattern_type    or "none"
        return (
            f"[VISITOR PROFILE] {adaptation_tag} organism"
            f" — {personality}, freq={state.touch_freq:.1f}/min\n"
            f"[ORGANISM STATE] Adaptation: {state.n_pairs}/50 pairs"
            f" | Region: {region} | Pattern: {pattern}\n"
            f"[MUSIC CUE] {self._music_cue(state)}"
        )

    def _ghost_overlay(self, ghost_state) -> str:
        if ghost_state.active:
            remaining = ghost_state.remaining
            return (
                f"[GHOST REPLAY ACTIVE] Echo dissolving in {remaining:.0f}s\n"
                f"[MUSIC CUE] Ghost melody over present rhythm, fade over {remaining:.0f}s"
            )
        else:
            t = ghost_state.t_until
            return (
                f"[GHOST REPLAY IMMINENT] Memory surfacing in {t:.0f}s\n"
                f"[MUSIC CUE] Liminal — prepare echo texture, suspend rhythm"
            )

    def _adaptation_tag(self, n_pairs: int) -> str:
        if n_pairs < 5:   return "virgin"
        if n_pairs < 15:  return "awakening"
        if n_pairs < 30:  return "learning"
        return "evolved"

    def _personality_tag(self, state) -> str:
        if state.avg_speed > 0.7 and state.linearity > 0.6:
            return "driven explorer"
        if state.avg_speed < 0.3 and state.circularity > 0.5:
            return "meditative wanderer"
        return "restless seeker"

    def _music_cue(self, state) -> str:
        if state.n_pairs < 5:
            return "Ambient sparse — open space, anticipation, no rhythm"
        if state.n_pairs < 20:
            return f"Slowly evolving — {state.bpm}bpm, sparse piano, building texture"
        return f"Sustained groove — {state.bpm}bpm, layered strings, {state.texture}"

    def _initial_narrative(self) -> str:
        return (
            "[VISITOR PROFILE] virgin organism — awaiting first contact\n"
            "[ORGANISM STATE] Adaptation: 0/50 | Region: none | Pattern: none\n"
            "[MUSIC CUE] Ambient sparse — open space, anticipation, no rhythm"
        )
```

---

## 단계별 내러티브 예시

### 세션 시작 (0~30초)
```
[VISITOR PROFILE] virgin organism — awaiting first contact
[ORGANISM STATE] Adaptation: 0/50 | Region: none | Pattern: none
[MUSIC CUE] Ambient sparse — open space, anticipation, no rhythm
```

### 각성 (30초~1분)
```
[VISITOR PROFILE] awakening organism — driven explorer, freq=12.3/min
[ORGANISM STATE] Adaptation: 8/50 | Region: center | Pattern: radial
[MUSIC CUE] Slowly evolving — 75bpm, sparse piano, building texture
```

### 적응 완료 (1~2분)
```
[VISITOR PROFILE] evolved organism — meditative wanderer, freq=8.4/min
[ORGANISM STATE] Adaptation: 32/50 | Region: upper-left | Pattern: circular
[MUSIC CUE] Sustained groove — 85bpm, layered strings, circular harmonic motion
```

### Ghost Replay 직전 (T-10초)
```
[GHOST REPLAY IMMINENT] Memory surfacing in 8s
[VISITOR PROFILE] evolved organism — restless seeker
[MUSIC CUE] Liminal — current groove dissolving into reverb, prepare echo layer
```

### Ghost Replay 중
```
[GHOST REPLAY ACTIVE] Echo dissolving in 12s
[VISITOR PROFILE] evolved organism — meditative wanderer
[MUSIC CUE] Ghost melody over present rhythm, fade over 12s
```

---

## Gemini Live 연결 코드 스케치

```javascript
// 브라우저에서 Tolvera 비디오 + Lyria 오디오 → Gemini Live
const videoStream = canvas.captureStream(30);  // Tolvera canvas
const audioStream = getAudioContextStream();   // Lyria PCM output

const ws = new WebSocket(
  `wss://generativelanguage.googleapis.com/ws/google.ai.generativelanguage.v1beta.GenerativeService.BidiGenerateContent?key=${API_KEY}`
);

ws.onopen = () => {
    // 시스템 프롬프트 + 응답 스키마 설정
    ws.send(JSON.stringify({
        setup: {
            model: "models/gemini-2.5-flash-preview-native-audio-dialog",
            generation_config: {
                response_modalities: ["TEXT"],
                response_mime_type: "application/json",
                response_schema: RESPONSE_SCHEMA
            },
            system_instruction: {
                parts: [{ text: SYSTEM_PROMPT.replace("{{SESSION_CONTEXT}}", narrativeManager.get()) }]
            }
        }
    }));
};

// 3.5초마다 비디오 프레임 + 오디오 청크 전송
setInterval(() => {
    const context = narrativeManager.get(ghostState);
    updateSystemContext(context);  // 세션 컨텍스트 갱신
    sendVideoFrame(videoStream);
    sendAudioChunk(audioBuffer);
}, 3500);

ws.onmessage = (event) => {
    const actions = JSON.parse(event.data);
    // Lyria 파라미터 적용
    lyria.setWeightedPrompts(actions.lyria_prompts);
    lyria.setConfig({ density: actions.density, brightness: actions.brightness });
    // Tolvera 파라미터 적용 (선택적)
    if (actions.tolvera) {
        osc.send("/tolvera/boids_separation", actions.tolvera.boids_separation);
    }
};
```
